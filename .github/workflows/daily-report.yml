name: Daily Stock Health Report

on:
  schedule:
    # 08:10 UTC is 16:10 TPE (Taiwan Time), running Mon-Fri
    - cron: '10 8 * * 1-5'
  workflow_dispatch:
    # Allows manual triggering

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    # Optional parameters that you can tweak via Repository Variables/Secrets if needed
    env:
      WATCHLIST_TW: ${{ vars.WATCHLIST_TW || secrets.WATCHLIST_TW || '2330,8299,2867,2881,0050,2317,2454,2308,3231' }}
      BACKTEST_WINDOW: "120"
      REPORT_TIMEZONE: "Asia/Taipei"
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      # chat_id ç¾åœ¨ç”± Upstash Redis å‹•æ…‹æä¾›ï¼ˆé€é /api/telegram/webhook è‡ªå‹•æ›´æ–°ï¼‰
      # è‹¥ Redis ç„¡è³‡æ–™ï¼Œæœƒ fallback åˆ°æ­¤ envï¼ˆå¯é¸ï¼Œä½œç‚ºä¿åº•ï¼‰
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
      UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Generate Daily Report
        run: npm run report:daily

      - name: Commit and Push Report
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add reports/
          # Commit will only happen if there are changes
          git diff --quiet && git diff --staged --quiet || (git commit -m "docs: ğŸ“ˆ Add daily stock report [skip ci]" && git push)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
